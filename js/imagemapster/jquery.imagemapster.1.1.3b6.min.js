/* jquery.imagemapster.js 1.1.3 beta 6
(c) 2011 James Treworgy 
MIT License
http://www.outsharked.com/imagemapster
https://github.com/jamietre/ImageMapster
*/
(function($){var m;$.fn.mapster=function(a){if(m[a]){return m[a].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof a==='object'||!a){return m.bind.apply(this,arguments)}else{$.error('Method '+a+' does not exist on jQuery.mapster')}};$.mapster={};$.mapster.utils={area_corner:function(a,b,c){var d,bestY,curX,curY,coords,j;coords=[];$(a).each(function(){coords=coords.concat(this.coords.split(','))});d=b?999999:-1;bestY=c?999999:-1;for(j=coords.length-2;j>=0;j-=2){curX=parseInt(coords[j],10);curY=parseInt(coords[j+1],10);if(c?curY<bestY:curY>bestY){bestY=curY;if(b?curX<d:curX>d){d=curX}}}return[d,bestY]},mergeObjects:function(a){var b,i,len,prop,add=this.boolOrDefault(a.add,a.template?false:true),ignore=a.ignore?a.ignore.split(','):'',include=a.include?a.include.split(','):'',deep=a.deep?a.deep.split(','):'',target=a.target||{},source=[].concat(a.source);if(a.template){target=this.mergeObjects({target:{},source:[a.template,target]})}len=source.length;for(i=0;i<len;i++){b=source[i];if(b){for(prop in b){if((!ignore||this.arrayIndexOf(ignore,prop)===-1)&&(!include||this.arrayIndexOf(include,prop)>=0)&&b.hasOwnProperty(prop)&&(add||target.hasOwnProperty(prop))){if(deep&&this.arrayIndexOf(deep,prop)>=0&&typeof b[prop]==='object'){if(typeof target[prop]!=='object'&&add){target[prop]={}}this.mergeObjects({target:target[prop],source:b[prop],add:add})}else{target[prop]=this.clone(b[prop])}}}}}return target},clone:function(a){var b,i,target,len;if($.isArray(a)){target=[];len=a.length;for(i=0;i<len;i++){target.push(a[i])}}else if(typeof a==='object'&&a){target={};for(b in a){if(a.hasOwnProperty(b)){target[b]=a[b]}}}else{target=a}return target},isElement:function(o){return(typeof HTMLElement==="object"?o instanceof HTMLElement:typeof o==="object"&&o.nodeType===1&&typeof o.nodeName==="string")},arrayIndexOfProp:function(a,b,c){var i=a.length;while(i--){if(a[i]&&a[i][b]===c){return i}}return-1},boolOrDefault:function(a,b){return this.isBool(a)?a:b||false},isBool:function(a){return typeof a==="boolean"},isFunction:function(a){return a&&typeof a==='function'},ifFunction:function(a,b,c){if(this.isFunction(a)){a.call(b,c)}},arrayIndexOf:function(a,b){if(a.indexOf){return a.indexOf(b)}else{var i;for(i=a.length-1;i>=0;i--){if(a[i]===b){return i}}return-1}},arrayReuse:function(a,b){var c=this.arrayIndexOf(a,null);if(c===-1){c=a.push(b)-1}else{a[c]=b}return c},each:function(a,b){var i,l;if(a.constructor===Array){l=a.length;for(i=0;i<l;i++){if(b.call(a[i],i)===false){return false}}}else{for(i in a){if(a.hasOwnProperty(i)){if(b.call(a[i],i)===false){return false}}}}return true},fader:(function(){function setOpacity(e,a){e.style.filter="Alpha(opacity="+String(a*100)+")";e.style.opacity=a}var f=[],lastKey=0,fade_func=function(a,b,c,d){var e,u=$.mapster.utils,obj;if(typeof a==='number'){e=u.arrayIndexOfProp(f,'key',a);if(e===-1){return}else{obj=f[e].element}}else{e=u.arrayIndexOfProp(f,'element',a);if(e>=0){f[e]=null}obj=a;a=++lastKey;u.arrayReuse(f,{"element":obj,"key":a})}c=c||1;b=(b+(c/10)>c-0.01)?c:b+(c/10);setOpacity(obj,b);if(b<c){setTimeout(function(){fade_func(a,b,c,d)},d?d/10:15)}};return fade_func}())};$.mapster.default_tooltip_container=function(){return'<div class="mapster-tooltip" style="border: 2px solid black; background: #EEEEEE; position:absolute; width:160px; padding:4px; margin: 4px; -moz-box-shadow: 3px 3px 5px #535353; '+'-webkit-box-shadow: 3px 3px 5px #535353; box-shadow: 3px 3px 5px #535353; -moz-border-radius: 6px 6px 6px 6px; -webkit-border-radius: 6px; '+'border-radius: 6px 6px 6px 6px;"></div>'};$.mapster.render_defaults={fade:true,fadeDuration:150,altImage:null,altImageOpacity:0.7,fill:true,fillColor:'000000',fillColorMask:'FFFFFF',fillOpacity:0.5,stroke:false,strokeColor:'ff0000',strokeOpacity:1,strokeWidth:1,includeKeys:'',alt_image:null};$.mapster.defaults=$.mapster.utils.mergeObjects({source:[{render_highlight:{},render_select:{fade:false},staticState:null,selected:false,isSelectable:true,isDeselectable:true,singleSelect:false,wrapClass:false,onGetList:null,sortList:false,listenToList:false,mapKey:'',isMask:false,mapValue:'',listKey:'value',listSelectedAttribute:'selected',listSelectedClass:null,showToolTip:false,toolTipFade:true,toolTipClose:['area-mouseout'],toolTipContainer:$.mapster.default_tooltip_container(),onClick:null,onMouseover:null,onMouseout:null,onStateChange:null,onShowToolTip:null,boundList:null,onCreateTooltip:null,onConfigured:null,configTimeout:10000,noHrefIsMask:true,areas:[]},$.mapster.render_defaults]});$.mapster.area_defaults=$.mapster.utils.mergeObjects({source:[$.mapster.defaults,{toolTip:''}],deep:"render_highlight, render_select",include:"fade,fadeDuration,fill,fillColor,fillOpacity,stroke,strokeColor,strokeOpacity,strokeWidth,staticState,selected,"+"isSelectable,isDeselectable,render_highlight,render_select,isMask, toolTip"});$.mapster.impl=(function(){var k={},p,AreaData,MapData,Method,u=$.mapster.utils,map_cache=[],ie_config_complete=false,has_canvas=null,graphics=null,canvas_style={position:'absolute',left:0,top:0,padding:0,border:0},is_image_loaded=function(b){var c,images=u.mergeObjects({source:[{main:b},b.alt_images]});return u.each(images,function(){c=this.image;var a=c.complete||(c.width&&c.height)||(typeof c.naturalWidth!=="undefined"&&c.naturalWidth!==0);return a})};k.test=function(a){return eval(a)};function shape_from_area(a){var i,coords=a.getAttribute('coords').split(',');for(i=coords.length-1;i>=0;i--){coords[i]=parseInt(coords[i],10)}return[a.getAttribute('shape').toLowerCase().substr(0,4),coords]}function create_canvas(a){return $(graphics.create_canvas_for(a)).css(canvas_style)[0]}function add_shape_group_impl(a,b){var c,shape;c=a.effectiveOptions();c=u.mergeObjects({source:[$.mapster.render_defaults,c,c['render_'+b],{alt_image:a.owner.alt_images[b]}]});u.each(a.areas,function(){shape=shape_from_area(this);graphics.add_shape_to(shape[0],shape[1],c,$(this).data('mapster_is_mask')||c.isMask)});return c}function add_shape_group(a,b){var c,canvas,name,map_data=a.owner,opts=a.effectiveOptions();if(b==='select'){name="static_"+a.areaId.toString();canvas=map_data.base_canvas}else{canvas=map_data.overlay_canvas}graphics.init(a.owner);graphics.begin(canvas,name);if(opts.includeKeys){c=opts.includeKeys.split(',');u.each(c,function(){add_shape_group_impl(map_data.getDataForKey(this.toString()),b)})}opts=add_shape_group_impl(a,b);graphics.render();if(opts.fade){u.fader(canvas,0,opts.fillOpacity,opts.fadeDuration)}}function get_map_data_index(a){var b,id;switch(a.tagName&&a.tagName.toLowerCase()){case'area':id=$(a).parent().attr('name');b=$("img[usemap='#"+id+"']")[0];break;case'img':b=a;break}return b?u.arrayIndexOfProp(map_cache,'image',b):-1}function get_map_data(a){var b=get_map_data_index(a);if(b>=0){return b>=0?map_cache[b]:null}}function setBoundListProperties(a,b,c){b.each(function(){if(a.listSelectedClass){if(c){$(this).addClass(a.listSelectedClass)}else{$(this).removeClass(a.listSelectedClass)}}if(a.listSelectedAttribute){$(this).attr(a.listSelectedAttribute,c)}})}function getBoundList(a,b){return a.boundList?a.boundList.filter(':attrMatches("'+a.listKey+'","'+b+'")'):null}function queue_command(a,b,c){if(!a.complete){a.commands.push({command:b,args:c});return true}return false}Method=function(a,b,c,d,e){var f=this;f.output=a;f.input=a;f.first=false;f.args=Array.prototype.slice.call(b,0);f.key='';f.func_map=c;f.func_area=d;$.extend(f,e)};Method.prototype.go=function(){var i,data,ar,len,result,src=this.input;len=src.length;for(i=0;i<len;i++){data=get_map_data(src[i]);if(data){ar=data.getData(src[i].nodeName==='AREA'?src[i]:this.key);if(ar){result=this.func_area.apply(ar,this.args)}else{result=this.func_map.apply(data,this.args)}if(this.first){break}}}if(typeof result!=='undefined'){return result}else{return k.output}};MapData=function(b,c){var d=this;this.index=-1;this.image=b;this.map=null;this.options=c;this.area_options=u.mergeObjects({template:$.mapster.area_defaults,source:c});this.base_canvas=null;this.overlay_canvas=null;this.alt_images={};this.complete=false;this.commands=[];this.data=[];this.img_style=b.getAttribute('style')||null;this.bind_tries=c.configTimeout/200;this._xref={};this._highlightId=-1;this._tooltip_events=[];this.mouseover=function(e){var a,ar=d.getDataForArea(this);a=ar.effectiveOptions();if(!u.isBool(a.staticState)){ar.highlight()}if(d.options.showToolTip&&a.toolTip&&d.activeToolTipID!==ar.areaId){ar.showTooltip(this)}if(u.isFunction(a.onMouseover)){a.onMouseover.call(this,e,{options:a,key:ar.key,selected:ar.isSelected()})}};this.mouseout=function(e){var a,data,opts=d.options;if(opts.toolTipClose&&u.arrayIndexOf(opts.toolTipClose,'area-mouseout')>=0){d.clearTooltip()}data=d.highlightId?d.data[d.highlightId]:null;a=data?data.key:'';d.ensureNoHighlight();if(u.isFunction(opts.onMouseout)){opts.onMouseout.call(this,{e:e,key:a,selected:data?data.isSelected():null})}};this.click=function(e){var a,list_target,newSelectionState,canChangeState,ar=d.getDataForArea(this),opts=d.options;e.preventDefault();opts=d.options;canChangeState=(ar.isSelectable()&&(ar.isDeselectable()||!ar.isSelected()));if(canChangeState){newSelectionState=!ar.isSelected()}else{newSelectionState=ar.isSelected()}list_target=getBoundList(opts,ar.key);if(u.isFunction(opts.onClick)){if(false===opts.onClick.call(this,{e:e,listTarget:list_target,key:ar.key,selected:newSelectionState})){return}}if(canChangeState){a=ar.toggleSelection()}if(opts.boundList&&opts.boundList.length>0){setBoundListProperties(opts,list_target,ar.isSelected())}}};p=MapData.prototype;p._idFromKey=function(a){return typeof a==="string"&&this._xref.hasOwnProperty(a)?this._xref[a]:-1};p.getDataForArea=function(a){var b,key=$(a).data('mapster_key');b=this.data[this._idFromKey(key)];if(b){b.area=a}return b};p.getDataForKey=function(a){return this.data[this._idFromKey(a)]};p.getData=function(a){if(typeof a==='string'){return this.getDataForKey(a)}else if(a instanceof jQuery||u.isElement(a)){return this.getDataForArea(a)}else{return null}};p.ensureNoHighlight=function(){var a;if(this._highlightId>=0){graphics.init(this);graphics.clear_highlight();a=this.data[this._highlightId];a.changeState('highlight',false);this._highlightId=-1}};p.setHighlight=function(a){this._highlightId=a};p.initGraphics=function(){graphics.init(this)};p.setAreaOptions=function(a){var i,area_options,ar,selected_list=[],areas=a||{};for(i=areas.length-1;i>=0;i--){area_options=areas[i];ar=this.getDataForKey(area_options.key);if(ar){u.mergeObjects({target:ar.options,source:area_options});if(u.isBool(area_options.selected)){ar.selected=area_options.selected}}}u.each(this.data,function(i){if(this.isSelectedOrStatic()){selected_list.push(i)}});return selected_list};p.setAreasSelected=function(a){var i;this.initGraphics();for(i=a.length-1;i>=0;i--){this.data[a[i]].setAreaSelected()}};p.initialize=function(){var d,area,sel,areas,i,j,keys,key,area_id,default_group,group_value,sort_func,sorted_list,is_mask,dataItem,k=this,selected_list=[],opts=this.options;function add_group(a,b){var c=new AreaData(k,a,b,opts);c.areaId=k._xref[a]=k.data.push(c)-1;return c.areaId}this._xref={};this.data=[];default_group=!opts.mapKey;sel=($.browser.msie&&$.browser.version<=7)?'area':(default_group?'area[coords]':'area['+opts.mapKey+']');areas=$(this.map).find(sel);for(i=areas.length-1;i>=0;i--){area_id=0;area=areas[i];d=$(area);key=area.getAttribute(opts.mapKey);keys=(default_group||typeof key!=='string')?['']:key.split(',');for(j=keys.length-1;j>=0;j--){key=keys[j];if(opts.mapValue){group_value=d.attr(opts.mapValue)}if(default_group){area_id=add_group(this.data.length,group_value);dataItem=this.data[area_id];dataItem.key=key=area_id.toString()}else{area_id=this._xref[key];if(area_id>=0){dataItem=this.data[area_id];if(group_value&&!this.data[area_id].value){dataItem.value=group_value}}else{area_id=add_group(key,group_value);dataItem=this.data[area_id]}}dataItem.areas.push(area)}d.data('mapster_key',key);is_mask=opts.isMask;if(!area.getAttribute("nohref")&&area.getAttribute("href")){d.bind('mouseover.mapster',this.mouseover).bind('mouseout.mapster',this.mouseout).bind('click.mapster',this.click)}else{is_mask=is_mask||opts.noHrefIsMask;d.data('mapster_is_mask',is_mask)}}selected_list=this.setAreaOptions(opts.areas);if(opts.isSelectable&&opts.onGetList){sorted_list=this.data.slice(0);if(opts.sortList){if(opts.sortList==="desc"){sort_func=function(a,b){return a===b?0:(a>b?-1:1)}}else{sort_func=function(a,b){return a===b?0:(a<b?-1:1)}}sorted_list.sort(function(a,b){a=a.value;b=b.value;return sort_func(a,b)})}this.options.boundList=opts.onGetList.call(this.image,sorted_list)}this.setAreasSelected(selected_list)};p.clearEvents=function(){$(this.map).find('area').unbind('mouseover.mapster').unbind('mouseout.mapster').unbind('click.mapster')};p._clearCanvases=function(a){var b=[[this,"overlay_canvas"],[this.alt_images.select,"canvas"],[this.alt_images.highlight,"canvas"]];if(!a){b.push([this,"base_canvas"])}u.each(b,function(){if(this[0]&&this[0][this[1]]){$(this[0][this[1]]).remove();this[0][this[1]]=null}})};p.clearTooltip=function(){if(this.activeToolTip){this.activeToolTip.remove();this.activeToolTip=null;this.activeToolTipID=-1}u.each(this._tooltip_events,function(){this.object.unbind(this.event)})};p.clearMapData=function(a){var b;this._clearCanvases(a);u.each(this.data,function(){this.areas=null});this.data=null;if(!a){b=$('div#mapster_wrap_'+this.index);if(b.length){b.before(b.children()).remove()}if(!this.img_style){while($(this.image).attr('style')){$(this.image).removeAttr('style')}}else{$(this.image).attr('style',this.img_style)}}this.image=null;u.each(this.alt_images,function(){this.canvas=null;this.image=null});this.clearTooltip()};p.bindTooltipClose=function(a,b,c){var d=b+'.mapster-tooltip',k=this;if(u.arrayIndexOf(this.options.toolTipClose,a)>=0){c.unbind(d).bind(d,function(){k.clearTooltip()});this._tooltip_events.push({object:c,event:d})}};AreaData=function(a,b,c){this.owner=a;this.key=b||'';this.areaId=-1;this.value=c||'';this.options={};this.selected=null;this.areas=[];this.area=null;this._effectiveOptions=null};p=AreaData.prototype;p.isSelectedOrStatic=function(){var o=this.effectiveOptions();return u.isBool(this.selected)?this.selected:(u.isBool(o.staticState)?o.staticState:(u.isBool(this.owner.options.staticState)?this.owner.options.staticState:false))};p.isSelected=function(){return this.selected||false};p.isSelectable=function(){return u.isBool(this.effectiveOptions().staticState)?false:(u.isBool(this.owner.options.staticState)?false:this.effectiveOptions().isSelectable)};p.isDeselectable=function(){return u.isBool(this.effectiveOptions().staticState)?false:(u.isBool(this.owner.options.staticState)?false:this.effectiveOptions().isDeselectable)};p.effectiveOptions=function(a){if(!this._effectiveOptions){this._effectiveOptions=u.mergeObjects({source:[this.owner.area_options,this.options,a||{},{id:this.areaId}],deep:"render_highlight,render_select"})}return this._effectiveOptions};p.changeState=function(a,b){if(u.isFunction(this.owner.options.onStateChange)){this.owner.options.onStateChange.call(this.owner.image,{key:this.key,state:a,selected:b})}};p.highlight=function(){add_shape_group(this,"highlight");this.owner.setHighlight(this.areaId);this.changeState('highlight',true)};p.setAreaSelected=function(){add_shape_group(this,"select");this.changeState('select',true)};p.addSelection=function(){var o=this.owner;o.initGraphics();if(o.options.singleSelect){graphics.clear_selections();u.each(o.data,function(){this.selected=false})}if(!this.isSelected()){this.setAreaSelected();this.selected=true}if(o.options.singleSelect){graphics.refresh_selections()}};p.removeSelection=function(){var o=this.owner;o.initGraphics();if(this.selected===false){return}this.selected=false;graphics.clear_selections(this.areaId);graphics.refresh_selections();graphics.clear_highlight();this.changeState('select',false)};p.toggleSelection=function(){if(!this.isSelected()){this.addSelection()}else{this.removeSelection()}return this.isSelected()};p.showTooltip=function(a){var b,left,top,tooltipCss,coords,container,alignLeft=true,alignTop=true,opts=this.effectiveOptions(),map_data=this.owner,baseOpts=map_data.options,template=map_data.options.toolTipContainer,area=a||this.areas;if(typeof template==='string'){container=$(template)}else{container=$(template).clone()}b=container.html(opts.toolTip).hide();coords=u.area_corner(area,alignLeft,alignTop);map_data.clearTooltip();$(map_data.image).after(b);map_data.activeToolTip=b;map_data.activeToolTipID=this.areaId;left=coords[0]-b.outerWidth(true);top=coords[1]-b.outerHeight(true);if(left<0){alignLeft=false}if(top<0){alignTop=false}coords=u.area_corner(area,alignLeft,alignTop);left=coords[0]-(alignLeft?b.outerWidth(true):0);top=coords[1]-(alignTop?b.outerHeight(true):0);tooltipCss={"left":left+"px","top":top+"px"};if(!b.css("z-index")||b.css("z-index")==="auto"){tooltipCss["z-index"]="2000"}b.css(tooltipCss).addClass('mapster_tooltip');map_data.bindTooltipClose('area-click','click',$(map_data.map));map_data.bindTooltipClose('tooltip-click','click',b);b.show();if(opts.toolTipFade){b.css({"opacity":0});u.fader(b[0],0,1,opts.fadeDuration)}u.ifFunction(baseOpts.onShowToolTip,area,{toolTip:b,areaOptions:opts,key:this.key,selected:this.isSelected()})};k.get=function(a){var b,result;this.each(function(){b=get_map_data(this);if(!b){return true}if(a){result=b.getDataForKey(a).isSelected();return false}result='';u.each(b.data,function(){if(this.isSelected()){result+=(result?',':'')+this.key}});return false});return result};k.data=function(a){return(new Method(this,arguments,null,function(){return this},{key:a})).go()};k.tooltip=function(a){return(new Method(this,arguments,function(){this.clearTooltip()},function(){if(this.effectiveOptions().toolTip){this.showTooltip(this.area)}},{key:a})).go()};k.highlight=function(c){return(new Method(this,arguments,function(a){var b;if(c===false){this.ensureNoHighlight()}else{b=this._highlightId;return b>=0?this.data[b].key:null}},function(){this.highlight()},{key:c})).go()};k.set=function(b,c,d){var e,parent,map_data,key_list,do_set_bound;function setSelection(a){switch(b){case true:a.addSelection();break;case false:a.removeSelection();break;default:a.toggleSelection();break}}do_set_bound=u.isBool(d)?d:true;this.each(function(){var a;map_data=get_map_data(this);if(!map_data){return true}key_list='';if($(this).is('img')){if(queue_command(map_data,'set',[b,c,d])){return true}if(c instanceof Array){key_list=c.join(",")}else{key_list=c}u.each(key_list.split(','),function(){setSelection(map_data.getDataForKey(this.toString()))})}else{parent=$(this).parent()[0];if(e&&parent!==e){map_data=get_map_data(this);if(!map_data){return true}e=parent}e=parent;a=map_data.getDataForArea(this);if(queue_command(map_data,'set',[b,a.key,do_set_bound])){return true}if((key_list+",").indexOf(a.key)<0){key_list+=(key_list===''?'':',')+a.key}setSelection(a)}if(do_set_bound&&map_data.options.boundList){setBoundListProperties(map_data.options,getBoundList(map_data.options,key_list),b)}});return this};k.unbind=function(a){var b;return this.each(function(){b=get_map_data(this);if(b){if(queue_command(b,'unbind')){return true}b.clearEvents();b.clearMapData(a);map_cache[b.index]=null}})};function merge_areas(a,b){var c,index,map_areas=a.options.areas;if(b){u.each(b,function(){index=u.arrayIndexOfProp(map_areas,"key",this.key);if(index>=0){$.extend(map_areas[index],this)}else{map_areas.push(this)}c=a.getDataForKey(this.key);if(c){$.extend(c.options,this)}})}}function merge_options(a,b){u.mergeObjects({ignore:"areas",target:a.options,source:b,deep:"render_select,render_highlight"});merge_areas(a,b.areas);u.mergeObjects({target:a.area_options,source:a.options,add:false});u.each(a.data,function(){this._effectiveOptions=null})}k.rebind=function(a){var b,selected_list;this.filter('img').each(function(){b=get_map_data(this);if(b){if(queue_command(b,'rebind',[a])){return true}merge_options(b,a);selected_list=b.setAreaOptions(a.areas||{});b.setAreasSelected(selected_list)}});return this};k.get_options=function(a,b){var c,ar,map_data,img=this.filter('img').first()[0];b=u.isBool(a)?a:b;if(map_data=get_map_data(img)){if(typeof a==='string'){if(ar=map_data.getDataForKey(a)){c=b?ar.effectiveOptions():ar.options}}else{c=map_data.options;if(b){c.render_select=u.mergeObjects({template:$.mapster.render_defaults,source:[c,c.render_select]});c.render_highlight=u.mergeObjects({template:$.mapster.render_defaults,source:[c,c.render_highlight]})}}return c}return null};k.set_options=function(a){var b=this.filter('img')[0],map_data=get_map_data(b);if(map_data){if(queue_command(map_data,'set_options',[a])){return true}merge_options(map_data,a)}return this};k.bind=function(c){var d=u.mergeObjects({source:[$.mapster.defaults,c],deep:"render_select,render_highlight"});return this.each(function(){var b,lastProp,img,wrap,map,canvas,context,overlay_canvas,usemap,map_data,parent_id,wrap_id;img=$(this);map_data=get_map_data(this);if(map_data&&map_data.complete){k.unbind.call(img);map_data=null}usemap=this.getAttribute('usemap');map=usemap&&$('map[name="'+usemap.substr(1)+'"]');if(!(img.is('img')&&usemap&&map.size()>0)){return true}if(!map_data){map_data=new MapData(this,d);map_data.index=u.arrayReuse(map_cache,map_data)}if(has_canvas){b={};u.each(["highlight","select"],function(){var a=d["render_"+this].altImage||d.altImage;if(a){if(a!==b){b=a;lastProp=this;if(!map_data.alt_images[this]){map_data.alt_images[this]={image:new Image()};map_data.alt_images[this].image.src=a}}else{map_data.alt_images[this]=map_data.alt_images[lastProp]}}})}if(!is_image_loaded(map_data)){if(--map_data.bind_tries>0){setTimeout(function(){img.mapster(d)},200)}else{u.ifFunction(d.onConfigured,this,false)}return true}parent_id=img.parent().attr('id');wrap_id='mapster_wrap_'+map_data.index;if(parent_id&&parent_id.length>=12&&parent_id.substring(0,12)==="mapster_wrap"){img.parent().attr('id',wrap_id)}else{wrap=$('<div id="'+wrap_id+'"></div>').css({display:'block',background:'url('+this.src+')',position:'relative',padding:0,width:this.width,height:this.height});if(d.wrapClass){if(d.wrapClass===true){wrap.addClass($(this).attr('class'))}else{wrap.addClass(d.wrapClass)}}img.before(wrap).css('opacity',0).css(canvas_style);if(!has_canvas){img.css('filter','Alpha(opacity=0)')}wrap.append(img)}canvas=create_canvas(this);img.before(canvas);overlay_canvas=create_canvas(this);img.before(overlay_canvas);if(has_canvas){b={};u.each(map_data.alt_images,function(){if(this.image!==b.image){b=this;this.canvas=graphics.create_canvas_for(this.image);$(this.canvas).css({display:"none"});context=this.canvas.getContext("2d");context.drawImage(this.image,0,0)}else{this.canvas=b.canvas}})}map_data.map=map;map_data.base_canvas=canvas;map_data.overlay_canvas=overlay_canvas;map_data.initialize();if(!map_data.complete){map_data.complete=true;u.each(map_data.commands,function(){m[this.command].apply(img,this.args)});map_data.commands=[]}if(d.onConfigured&&typeof d.onConfigured==='function'){d.onConfigured.call(this,true)}})};k.init=function(g){var h,shapes;has_canvas=$('<canvas></canvas>')[0].getContext?true:false;if(!(has_canvas||document.namespaces)){$.fn.mapster=function(){return this};return}if(u.isBool(g)){has_canvas=g}if($.browser.msie&&!has_canvas&&!ie_config_complete){document.namespaces.add("v","urn:schemas-microsoft-com:vml");h=document.createStyleSheet();shapes=['shape','rect','oval','circ','fill','stroke','imagedata','group','textbox'];$.each(shapes,function(){h.addRule('v\\:'+this,"behavior: url(#default#VML); antialias:true")});ie_config_complete=true}if(has_canvas){graphics=(function(){var f,canvas,context,masks,shapes,k={};k.active=false;function css3color(b,c){function hex_to_decimal(a){return Math.max(0,Math.min(parseInt(a,16),255))}return'rgba('+hex_to_decimal(b.substr(0,2))+','+hex_to_decimal(b.substr(2,2))+','+hex_to_decimal(b.substr(4,2))+','+c+')'}function render_shape(a,b){var i,len;switch(a){case'rect':context.rect(b[0],b[1],b[2]-b[0],b[3]-b[1]);break;case'poly':context.moveTo(b[0],b[1]);len=b.length;for(i=2;i<len;i+=2){context.lineTo(b[i],b[i+1])}context.lineTo(b[0],b[1]);break;case'circ':context.arc(b[0],b[1],b[2],0,Math.PI*2,false);break}}function add_alt_image(a,b,c,d){context.save();context.beginPath();render_shape(b,c);context.closePath();context.clip();context.globalAlpha=d.altImageOpacity;context.drawImage(a,0,0);context.restore()}k.init=function(a){f=a};k.begin=function(a){canvas=a;context=canvas.getContext('2d');shapes=[];masks=[];k.active=true};k.render=function(){context.save();if(masks.length){u.each(masks,function(){context.beginPath();render_shape(this.shape,this.coords);context.closePath();context.fill()});context.globalCompositeOperation="source-out"}u.each(shapes,function(){var s=this;if(s.options.alt_image){add_alt_image(s.options.alt_image.canvas,s.shape,s.coords,s.options)}else if(s.options.fill){context.save();context.beginPath();render_shape(s.shape,s.coords);context.closePath();context.clip();context.fillStyle=css3color(s.options.fillColor,s.options.fillOpacity);context.fill();context.restore()}});context.restore();u.each(shapes.concat(masks),function(){var s=this;if(s.options.stroke){context.beginPath();render_shape(s.shape,s.coords);context.closePath();context.strokeStyle=css3color(s.options.strokeColor,s.options.strokeOpacity);context.lineWidth=s.options.strokeWidth;context.stroke()}});context=null;k.active=false;return canvas};k.create_canvas_for=function(a,b,d){var c,$img;if(a){$img=$(a);d=a.height||$img.height();b=a.width||$img.width()}c=$('<canvas></canvas>')[0];c.width=b;c.height=d;c.getContext("2d").clearRect(0,0,b,d);return c};k.add_shape_to=function(a,b,c,d){var e=d?masks:shapes;e.push({shape:a,coords:b,options:c})};k.clear_highlight=function(){f.overlay_canvas.getContext('2d').clearRect(0,0,f.overlay_canvas.width,f.overlay_canvas.height)};k.clear_selections=function(){return null};k.refresh_selections=function(){var a=[],canvas_temp;canvas_temp=f.base_canvas;u.each(f.data,function(i){if(this.isSelectedOrStatic()){a.push(i)}});f.base_canvas=create_canvas(f.image);$(f.base_canvas).hide();$(f.image).before(f.base_canvas);f.setAreasSelected(a);$(f.base_canvas).show();$(canvas_temp).remove()};return k}())}else{graphics=(function(){var f,map_data,canvas,name,masks,shapes,k={};k.active=false;function render_shape(a,b,c){var d,e,el_name,template;el_name=name?'name="'+name+'" ':'';f='<v:fill color="#'+c.fillColor+'" opacity="'+(c.fill?c.fillOpacity:0)+'" /><v:stroke opacity="'+c.strokeOpacity+'"/>';if(c.stroke){d='strokeweight='+c.strokeWidth+' stroked="t" strokecolor="#'+c.strokeColor+'"'}else{d='stroked="f"'}switch(a){case'rect':template='<v:rect '+el_name+' filled="t" '+d+' style="zoom:1;margin:0;padding:0;display:block;position:absolute;left:'+b[0]+'px;top:'+b[1]+'px;width:'+(b[2]-b[0])+'px;height:'+(b[3]-b[1])+'px;">'+f+'</v:rect>';break;case'poly':template='<v:shape '+el_name+' filled="t" '+d+' coordorigin="0,0" coordsize="'+canvas.width+','+canvas.height+'" path="m '+b[0]+','+b[1]+' l '+b.slice(2).join(',')+' x e" style="zoom:1;margin:0;padding:0;display:block;position:absolute;top:0px;left:0px;width:'+canvas.width+'px;height:'+canvas.height+'px;">'+f+'</v:shape>';break;case'circ':template='<v:oval '+el_name+' filled="t" '+d+' style="zoom:1;margin:0;padding:0;display:block;position:absolute;left:'+(b[0]-b[2])+'px;top:'+(b[1]-b[2])+'px;width:'+(b[2]*2)+'px;height:'+(b[2]*2)+'px;">'+f+'</v:oval>';break}e=$(template);$(canvas).append(e);return e}k.init=function(a){map_data=a};k.begin=function(a,b){canvas=a;name=b;shapes=[];masks=[];k.active=true};k.create_canvas_for=function(a){var b=$(a),width=b.width(),height=b.height();return $('<var width="'+width+'" height="'+height+'" style="zoom:1;overflow:hidden;display:block;width:'+width+'px;height:'+height+'px;"></var>')[0]};k.add_shape_to=function(a,b,c,d){var e=d?masks:shapes;e.push({shape:a,coords:b,options:c})};k.render=function(){var a;u.each(shapes,function(){render_shape(this.shape,this.coords,this.options)});if(masks.length){u.each(masks,function(){a=u.mergeObjects({source:[this.options,{fillOpacity:1,fillColor:this.options.fillColorMask}]});render_shape(this.shape,this.coords,a)})}k.active=false;return canvas};k.clear_highlight=function(){$(map_data.overlay_canvas).children().remove()};k.clear_selections=function(a){if(a>=0){$(map_data.base_canvas).find('[name="static_'+a.toString()+'"]').remove()}else{$(map_data.base_canvas).children().remove()}};k.refresh_selections=function(){return null};return k}())}};k.unload=function(){var i;for(i=map_cache.length-1;i>=0;i--){if(map_cache[i]){k.unbind.call($(map_cache[i].image))}}graphics=null};k.snapshot=function(){var d;return this.filter('img').each(function(){d=get_map_data(this);if(d){if(queue_command(d,'snapshot')){return true}u.each(d.data,function(){this.selected=false});d.base_canvas=create_canvas(d.image);$(d.base_canvas);$(d.image).before(d.base_canvas)}})};return k}());$.mapster.unload=function(){this.impl.unload();$.mapster.utils.fader=null;$.mapster.utils=null;$.mapster.impl=null;$.fn.mapster=null;$.mapster=null;$('*').unbind()};$.expr[':'].attrMatches=function(a,b,c,d){var i,j,curVal,quoteChar=c[2],arrArguments=eval("["+quoteChar+c[3]+quoteChar+"]"),compareList=arrArguments[1].split(','),node=$(a);for(i=0;i<arrArguments.length;i++){curVal=node.attr(arrArguments[0]);for(j=compareList.length-1;j>=0;j--){if(curVal===compareList[j]){return true}}}return false};m={bind:$.mapster.impl.bind,rebind:$.mapster.impl.rebind,unbind:$.mapster.impl.unbind,set:$.mapster.impl.set,get:$.mapster.impl.get,data:$.mapster.impl.data,highlight:$.mapster.impl.highlight,select:function(){$.mapster.impl.set.call(this,true)},deselect:function(){$.mapster.impl.set.call(this,false)},get_options:$.mapster.impl.get_options,set_options:$.mapster.impl.set_options,snapshot:$.mapster.impl.snapshot,tooltip:$.mapster.impl.tooltip,test:$.mapster.impl.test};$.mapster.impl.init()}(jQuery));